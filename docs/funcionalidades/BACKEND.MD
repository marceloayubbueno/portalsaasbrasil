# ğŸ“˜ DocumentaÃ§Ã£o Backend - Portal SaaS Brasil

> **Backend NestJS + MongoDB para o Portal SaaS Brasil**  
> Sistema de autenticaÃ§Ã£o multicliente com JWT e isolamento por tenant

---

## ğŸ“‘ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [Arquitetura do Sistema](#arquitetura-do-sistema)
3. [Estrutura de Pastas](#estrutura-de-pastas)
4. [Tecnologias Utilizadas](#tecnologias-utilizadas)
5. [Funcionamento do Backend](#funcionamento-do-backend)
6. [ConfiguraÃ§Ã£o Local](#configuraÃ§Ã£o-local)
7. [ConfiguraÃ§Ã£o do Render](#configuraÃ§Ã£o-do-render)
8. [Scripts e Comandos](#scripts-e-comandos)
9. [AutenticaÃ§Ã£o JWT Multicliente](#autenticaÃ§Ã£o-jwt-multicliente)
10. [Rotas da API](#rotas-da-api)
11. [VariÃ¡veis de Ambiente](#variÃ¡veis-de-ambiente)
12. [Como Restaurar o Projeto](#como-restaurar-o-projeto)
13. [Troubleshooting](#troubleshooting)
14. [Deploy e Build](#deploy-e-build)

---

## ğŸ¯ VisÃ£o Geral

### O que Ã© o Backend?

Backend desenvolvido em **NestJS** (TypeScript) que serve como API REST para o Portal SaaS Brasil. O sistema implementa:

- âœ… AutenticaÃ§Ã£o JWT com isolamento por cliente (`clientId`)
- âœ… Multi-tenancy com segregaÃ§Ã£o de dados por empresa
- âœ… Sistema de Administradores (Super Admin)
- âœ… GestÃ£o de Produtos SaaS e Categorias
- âœ… Seed automÃ¡tico de Super Admin na inicializaÃ§Ã£o
- âœ… Logs detalhados de seguranÃ§a e auditoria
- âœ… Tratamento global de erros
- âœ… ConfiguraÃ§Ã£o CORS para domÃ­nios especÃ­ficos

### Estrutura de URL

```
Backend (NestJS):     Render.com ou Railway
Frontend (Next.js):   Vercel.com (portalsaasbrasil.vercel.app)
```

---

## ğŸ—ï¸ Arquitetura do Sistema

### PadrÃ£o Arquitetural

**Modular (MVC Pattern com Dependency Injection)**

```
server/src/
â”œâ”€â”€ app.module.ts          # MÃ³dulo raiz
â”œâ”€â”€ main.ts                # Bootstrap da aplicaÃ§Ã£o
â”œâ”€â”€ admins/                # GestÃ£o de administradores
â”œâ”€â”€ auth/                  # AutenticaÃ§Ã£o JWT
â”‚   â”œâ”€â”€ guards/            # Guards de autenticaÃ§Ã£o
â”‚   â”œâ”€â”€ strategies/        # EstratÃ©gias JWT
â”‚   â””â”€â”€ decorators/        # Decorators customizados
â””â”€â”€ products/              # Produtos SaaS
```

### Fluxo de AutenticaÃ§Ã£o

```
1. Cliente faz login â†’ /auth/login
2. AuthService valida credenciais
3. JWT Ã© gerado com payload: { clientId, email, role }
4. Token Ã© retornado ao frontend
5. Frontend armazena token em localStorage
6. RequisiÃ§Ãµes subsequentes incluem: Authorization: Bearer <token>
7. Guards validam token e extraem clientId
8. ServiÃ§os filtram dados por clientId automaticamente
```

---

## ğŸ“ Estrutura de Pastas

```
server/
â”œâ”€â”€ dist/                  # CÃ³digo compilado (gerado automaticamente)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ admins/            # MÃ³dulo de Administradores
â”‚   â”‚   â”œâ”€â”€ entities/      # Schemas do MongoDB
â”‚   â”‚   â”œâ”€â”€ admins.controller.ts
â”‚   â”‚   â”œâ”€â”€ admins.service.ts
â”‚   â”‚   â””â”€â”€ seed-superadmin.ts  # ğŸ” Seed automÃ¡tico
â”‚   â”œâ”€â”€ auth/              # MÃ³dulo de AutenticaÃ§Ã£o
â”‚   â”‚   â”œâ”€â”€ guards/        # Guards JWT (Admin, Client, SaaS)
â”‚   â”‚   â”œâ”€â”€ strategies/   # JWT Strategy, JWT SaaS Strategy
â”‚   â”‚   â”œâ”€â”€ decorators/   # @ClientId decorator
â”‚   â”‚   â””â”€â”€ dto/          # LoginDto, RegisterDto
â”‚   â”œâ”€â”€ products/         # MÃ³dulo de Produtos SaaS
â”‚   â”‚   â”œâ”€â”€ entities/     # Product, Category, SaasCompany schemas
â”‚   â”‚   â”œâ”€â”€ saas-companies.controller.ts
â”‚   â”‚   â””â”€â”€ products.controller.ts
â”‚   â”œâ”€â”€ app.module.ts     # MÃ³dulo principal
â”‚   â””â”€â”€ main.ts           # Bootstrap
â”œâ”€â”€ package.json          # DependÃªncias e scripts
â”œâ”€â”€ tsconfig.json         # ConfiguraÃ§Ã£o TypeScript
â””â”€â”€ tsconfig.build.json   # ConfiguraÃ§Ã£o de build
```

---

## ğŸ› ï¸ Tecnologias Utilizadas

### Core
- **NestJS 11.1.0** - Framework Node.js
- **TypeScript 5.8.3** - Linguagem
- **Node.js 18.x** - Runtime

### Banco de Dados
- **MongoDB** - Banco NoSQL
- **Mongoose 7.8.7** - ODM

### AutenticaÃ§Ã£o
- **Passport** - Middleware de autenticaÃ§Ã£o
- **passport-jwt** - EstratÃ©gia JWT
- **bcryptjs** - Hash de senhas
- **@nestjs/jwt** - MÃ³dulo JWT NestJS

### ValidaÃ§Ã£o
- **class-validator** - ValidaÃ§Ã£o de DTOs
- **class-transformer** - TransformaÃ§Ã£o de objetos

### Desenvolvimento
- **ts-node** - Executar TypeScript
- **tsconfig** - ConfiguraÃ§Ã£o TypeScript

---

## âš™ï¸ Funcionamento do Backend

### 1. Bootstrap (main.ts)

```typescript
// Quando o servidor inicia:
1. Carrega variÃ¡veis de ambiente (.env)
2. Cria aplicaÃ§Ã£o NestJS
3. ğŸ” Executa seed automÃ¡tico do Super Admin
4. Configura arquivos estÃ¡ticos
5. Configura CORS para domÃ­nios permitidos
6. Configura filtro global de erros
7. Configura ValidationPipe global
8. Inicia servidor na porta especificada (PORT ou 3000)
```

### 2. Sistema de Seed AutomÃ¡tico

**Super Admin** Ã© criado automaticamente ao iniciar:

```typescript
// server/src/admins/seed-superadmin.ts
- Verifica se existe Super Admin no banco
- Se nÃ£o existir, cria automaticamente
- Email e senha definidos em .env
- Executa sempre que o servidor inicia
```

### 3. Guards de AutenticaÃ§Ã£o

#### **JwtAuthGuard** (Admin)
- Valida token JWT
- Extrai dados do admin autenticado
- Usado em rotas administrativas

#### **JwtClientAuthGuard** (Cliente)
- Valida token JWT + clientId
- Garante isolamento por cliente
- Logs de auditoria

#### **JwtSaasAuthGuard** (Saas)
- AutenticaÃ§Ã£o especÃ­fica para empresas SaaS
- EstratÃ©gia separada do JWT comum

### 4. Decorators Customizados

#### **@ClientId()**
```typescript
// Extrai clientId automaticamente do token JWT
@Get('/minha-rota')
async minhaRota(@ClientId() clientId: string) {
  // clientId jÃ¡ extraÃ­do e validado
}
```

### 5. Tratamento Global de Erros

```typescript
// GlobalExceptionLogger captura TODOS os erros
- Loga detalhes completos no console
- Retorna resposta JSON padronizada
- Status code correto
- Stack trace para debug
```

---

## ğŸ–¥ï¸ ConfiguraÃ§Ã£o Local

### PrÃ©-requisitos

```bash
âœ… Node.js 18.x ou superior
âœ… MongoDB local ou Atlas
âœ… Git
```

### Passo a Passo

#### 1. Clone o repositÃ³rio

```bash
git clone https://github.com/marceloayubbueno/portalsaasbrasil.git
cd portalsaasbrasil
```

#### 2. Entre na pasta server

```bash
cd server
```

#### 3. Instale as dependÃªncias

```bash
npm install
```

#### 4. Configure as variÃ¡veis de ambiente

```bash
# Copie o arquivo de exemplo
cp ENV.EXAMPLE .env

# Edite o .env com suas configuraÃ§Ãµes
```

#### 5. Configure MongoDB

**OpÃ§Ã£o A: MongoDB Local**
```bash
# Instale MongoDB localmente
# Configure MONGODB_URI em .env:
MONGODB_URI=mongodb://localhost:27017
```

**OpÃ§Ã£o B: MongoDB Atlas (Recomendado para produÃ§Ã£o)**
```bash
# Crie conta em mongodb.com/cloud/atlas
# Crie cluster gratuito (M0)
# Copie connection string
MONGODB_URI=mongodb+srv://user:password@cluster.mongodb.net/
```

#### 6. Configure Super Admin

Edite `.env`:
```env
SUPER_ADMIN_EMAIL=admin@exemplo.com
SUPER_ADMIN_PASSWORD=senhaForte123!
SUPER_ADMIN_NAME=Administrador Principal
```

#### 7. Execute o backend

```bash
# Desenvolvimento (hot reload)
npm run start:dev

# ProduÃ§Ã£o
npm run build
npm run start
```

#### 8. Verifique se estÃ¡ funcionando

Acesse: `http://localhost:3000`  
VocÃª verÃ¡ logs indicando que o servidor iniciou.

---

## â˜ï¸ ConfiguraÃ§Ã£o do Render

### Painel do Render

URL do Dashboard: https://dashboard.render.com

### ServiÃ§o: Web Service (NestJS Backend)

#### **ConfiguraÃ§Ãµes Gerais**

```
Name: programa-indicacao-server
Region: SÃ£o Paulo (Brazil)
Branch: main
Root Directory: (deixar vazio - pega raiz do repo)
```

#### **Build & Deploy**

```
Build Command: npm install && npm run build
Start Command: npm run start:prod
```

#### **Environment**

```
NODE_ENV=production
PORT=3000 (pode ser qualquer porta, Render fornece dinamicamente)

# MongoDB
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/

# JWT
JWT_SECRET=sua-chave-secreta-muito-segura-aqui

# URLs
CLIENT_URL=https://portalsaasbrasil.vercel.app
BACKEND_URL=https://programa-indicacao-server.onrender.com

# Super Admin
SUPER_ADMIN_EMAIL=admin@exemplo.com
SUPER_ADMIN_PASSWORD=SenhaSegura123!
SUPER_ADMIN_NAME=Super Administrador

# Email (opcional)
BREVO_API_KEY=seu-api-key
FROM_EMAIL=noreply@exemplo.com
FROM_NAME=Portal SaaS Brasil
```

#### **Auto-Deploy**

Render configura automaticamente ao fazer push no GitHub:
- Monitora branch `main`
- Faz build automaticamente
- Reinicia o serviÃ§o

---

## ğŸ“œ Scripts e Comandos

### package.json

```json
{
  "scripts": {
    "start:dev": "ts-node src/main.ts",     // Desenvolvimento com hot reload
    "build": "tsc -p tsconfig.build.json",  // Compila TypeScript
    "start": "node dist/main.js",          // ProduÃ§Ã£o (local)
    "start:prod": "node dist/main.js"      // ProduÃ§Ã£o (Render)
  }
}
```

### Comandos Ãšteis

```bash
# Desenvolvimento
npm run start:dev

# Build local
npm run build

# Testar build localmente
npm run build
npm run start

# Limpar dist
rm -rf dist

# Ver logs
npm run start:dev | grep "BOOT"
```

---

## ğŸ” AutenticaÃ§Ã£o JWT Multicliente

### Conceitos

**Multi-tenancy**: Sistema onde um Ãºnico backend serve mÃºltiplas empresas, mantendo dados isolados por `clientId`.

### Como Funciona

#### 1. Login

```typescript
POST /auth/login
{
  "email": "admin@empresa.com",
  "password": "senha123"
}

// Resposta:
{
  "access_token": "eyJhbGc...",
  "user": {
    "id": "...",
    "email": "admin@empresa.com",
    "clientId": "empresa-123"  // â† Isolamento
  }
}
```

#### 2. RequisiÃ§Ãµes Autenticadas

```typescript
GET /api/produtos
Headers: {
  "Authorization": "Bearer eyJhbGc..."
}

// Backend automaticamente:
// 1. Valida token
// 2. Extrai clientId do token
// 3. Filtra dados apenas daquele clientId
// 4. Retorna dados isolados
```

#### 3. Guards

```typescript
// Rota que precisa de autenticaÃ§Ã£o
@UseGuards(JwtAuthGuard)
@Get('produtos')
async listarProdutos(@ClientId() clientId: string) {
  // clientId jÃ¡ validado e extraÃ­do
  // Aplicar filtro por clientId
}
```

### EstratÃ©gias JWT

#### **JwtStrategy** (Admin)
```typescript
// Valida: { sub, email, role }
// Usado para: /admin/*
```

#### **JwtSaasStrategy** (Empresa SaaS)
```typescript
// Valida: { sub, email, clientId, role }
// Usado para: /saas/*
```

---

## ğŸ›£ï¸ Rotas da API

### AutenticaÃ§Ã£o

```
POST   /auth/login                # Login de admin
POST   /auth/saas-login          # Login de empresa SaaS
GET    /auth/admins               # Listar admins
POST   /auth/recreate-super-admin # Recriar Super Admin (emergÃªncia)
```

### Produtos SaaS

```
GET    /products                   # Listar produtos
POST   /products                   # Criar produto
GET    /products/:id               # Detalhes do produto
PUT    /products/:id               # Atualizar produto
DELETE /products/:id               # Deletar produto
```

### Categorias

```
GET    /products/categories         # Listar categorias
POST   /products/categories         # Criar categoria
```

### Empresas SaaS

```
GET    /products/saas-companies    # Listar empresas
POST   /products/saas-companies     # Criar empresa
```

---

## ğŸ”‘ VariÃ¡veis de Ambiente

### ObrigatÃ³rias

```env
# MongoDB
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/portalsaas

# JWT
JWT_SECRET=sua-chave-secreta-muito-segura

# Super Admin
SUPER_ADMIN_EMAIL=admin@exemplo.com
SUPER_ADMIN_PASSWORD=SenhaSegura123!
SUPER_ADMIN_NAME=Super Administrador
```

### Opcionais (com padrÃµes)

```env
# Servidor
PORT=3000
NODE_ENV=development

# CORS
CLIENT_URL=https://portalsaasbrasil.vercel.app
BACKEND_URL=https://seu-backend.onrender.com

# Email (opcional)
BREVO_API_KEY=sua-api-key
SMTP_HOST=smtp.brevo.com
SMTP_PORT=587
FROM_EMAIL=noreply@exemplo.com
FROM_NAME=Portal SaaS Brasil
```

---

## ğŸ”„ Como Restaurar o Projeto

### CenÃ¡rio 1: Clone Fresco

```bash
# 1. Clone
git clone https://github.com/marceloayubbueno/portalsaasbrasil.git
cd portalsaasbrasil/server

# 2. Instale dependÃªncias
npm install

# 3. Configure .env
cp ENV.EXAMPLE .env
# Edite .env com suas configuraÃ§Ãµes

# 4. Build
npm run build

# 5. Inicie
npm run start
```

### CenÃ¡rio 2: Backup Existente

```bash
# 1. Restaure backup do MongoDB
mongorestore --uri="mongodb://localhost:27017" /caminho/backup

# 2. Configure .env com dados corretos

# 3. Build e inicia
npm run build
npm run start
```

### CenÃ¡rio 3: Restaurar Apenas CÃ³digo

```bash
# 1. Re-clone ou pull
git pull origin main

# 2. Reinstale dependÃªncias (caso mudou)
npm install

# 3. Limpe e rebuild
rm -rf dist node_modules
npm install
npm run build
npm run start
```

### Seed do Super Admin

O Super Admin Ã© criado automaticamente ao iniciar o servidor:

```typescript
// server/src/main.ts (linha 49-56)
// Executa seed automÃ¡tico na inicializaÃ§Ã£o
```

Se precisar recriar manualmente:

```bash
# OpÃ§Ã£o 1: Via endpoint (precisa estar rodando)
POST /auth/recreate-super-admin
Body: { "confirmacao": "RECRIAR_SUPER_ADMIN_CONFIRMO" }

# OpÃ§Ã£o 2: Reiniciar o servidor
# O seed executa automaticamente
```

---

## ğŸ› Troubleshooting

### Erro: Cannot find module '/opt/render/project/src/server/dist/src/main.js'

**Causa**: `tsconfig.json` sem `rootDir` definido.

**SoluÃ§Ã£o**: Adicione `"rootDir": "./src"` no `tsconfig.json`:

```json
{
  "compilerOptions": {
    "rootDir": "./src",
    "outDir": "./dist"
  }
}
```

E ajuste scripts no `package.json`:
```json
{
  "scripts": {
    "start": "node dist/main.js",
    "start:prod": "node dist/main.js"
  }
}
```

---

### Erro: Cannot connect to MongoDB

**Causa**: `MONGODB_URI` incorreta ou banco inacessÃ­vel.

**SoluÃ§Ã£o**:
```bash
# 1. Verifique MONGODB_URI no .env
# 2. Teste conexÃ£o:
mongosh "mongodb+srv://user:pass@cluster.mongodb.net/"

# 3. Verifique firewall/whitelist (Atlas)
# 4. Use IP 0.0.0.0/0 para desenvolvimento
```

---

### Erro: JWT_SECRET nÃ£o definido

**Causa**: VariÃ¡vel de ambiente faltando.

**SoluÃ§Ã£o**:
```env
# .env ou Render Dashboard
JWT_SECRET=sua-chave-muito-segura-aqui-123456789
```

---

### Erro: CORS bloqueado

**SoluÃ§Ã£o**: Adicione o domÃ­nio no `main.ts`:

```typescript
app.enableCors({
  origin: [
    'https://portalsaasbrasil.vercel.app',
    'http://localhost:3000',
    'http://seu-dominio.com'  // â† Adicione aqui
  ],
  credentials: true,
});
```

---

### Super Admin nÃ£o criado automaticamente

**Causa**: VariÃ¡veis do Super Admin faltando.

**SoluÃ§Ã£o**:
```env
# .env ou Render
SUPER_ADMIN_EMAIL=admin@exemplo.com
SUPER_ADMIN_PASSWORD=SenhaSegura123!
SUPER_ADMIN_NAME=Super Admin
```

---

### Build falha no Render

**Verificar**:
1. âœ… `rootDir` definido no `tsconfig.json`
2. âœ… Scripts corretos no `package.json`
3. âœ… VariÃ¡veis de ambiente configuradas
4. âœ… MongoDB acessÃ­vel
5. âœ… Node.js 18.x no `engines` do `package.json`

---

## ğŸš€ Deploy e Build

### Build Local

```bash
# Compilar TypeScript
npm run build

# Verificar output
ls dist/

# Verificar main.js
node dist/main.js
```

### Estrutura de Build

```
server/
â”œâ”€â”€ src/              # CÃ³digo fonte (TypeScript)
â”‚   â”œâ”€â”€ main.ts
â”‚   â”œâ”€â”€ admins/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ dist/             # CÃ³digo compilado (JavaScript)
â”‚   â”œâ”€â”€ main.js       # â† Entrada principal
â”‚   â”œâ”€â”€ admins/
â”‚   â””â”€â”€ ...
â””â”€â”€ package.json
```

### ConfiguraÃ§Ã£o do Build (tsconfig.json)

```json
{
  "compilerOptions": {
    "rootDir": "./src",      // â† Define raiz como src/
    "outDir": "./dist",      // â† Output para dist/
    "target": "ES2023",
    "module": "commonjs"
  },
  "include": ["src/**/*"]   // â† Apenas arquivos de src/
}
```

### O que o Build Faz

```
1. tsconfig.json lÃª configuraÃ§Ãµes
2. rootDir define: cÃ³digo fonte estÃ¡ em src/
3. outDir define: output vai para dist/
4. TypeScript compila:
   src/main.ts â†’ dist/main.js
   src/admins/ â†’ dist/admins/
5. MantÃ©m estrutura de pastas
```

### Deploy no Render

1. **Push para GitHub**
   ```bash
   git add .
   git commit -m "fix: configuraÃ§Ã£o de build"
   git push origin main
   ```

2. **Render detecta push**
   - Trigger automÃ¡tico
   - Executa `npm install`
   - Executa `npm run build`
   - Executa `npm run start:prod`

3. **Verificar logs**
   - Dashboard â†’ Logs
   - Procurar por `ğŸš€ Backend rodando na porta`

---

## ğŸ“Š Monitoramento

### Logs Importantes

```bash
# InicializaÃ§Ã£o
[BOOT] ğŸš€ Backend rodando na porta 3000
[BOOT] ğŸ” AUTO-SEED: Super Admin criado
[BOOT] ğŸŒ CORS configurado

# AutenticaÃ§Ã£o
[GLOBAL ERROR] Token invÃ¡lido
[JwtAuthGuard] Cliente autenticado: client-123

# Erros
[GLOBAL ERROR] { timestamp, path, method, status, message }
```

### Health Check

```bash
# Endpoint: qualquer rota
GET https://seu-backend.onrender.com

# Ou:
GET https://seu-backend.onrender.com/products
```

---

## ğŸ”— Links Importantes

- **RepositÃ³rio**: https://github.com/marceloayubbueno/portalsaasbrasil
- **Render Dashboard**: https://dashboard.render.com
- **MongoDB Atlas**: https://cloud.mongodb.com
- **NestJS Docs**: https://docs.nestjs.com

---

## ğŸ“ Notas Finais

### Boas PrÃ¡ticas

âœ… **Nunca commitar** `.env` no Git  
âœ… **Sempre validar** dados com class-validator  
âœ… **Usar guards** em todas as rotas protegidas  
âœ… **Logar erros** com contexto completo  
âœ… **Isolar dados** por clientId automaticamente  
âœ… **Seed automÃ¡tico** de Super Admin  

### SeguranÃ§a

ğŸ”’ Tokens JWT com expiraÃ§Ã£o (1d)  
ğŸ”’ Hash de senhas com bcryptjs  
ğŸ”’ Isolamento por clientId obrigatÃ³rio  
ğŸ”’ ValidaÃ§Ã£o de dados em todas as rotas  
ğŸ”’ CORS configurado para domÃ­nios especÃ­ficos  

### ManutenÃ§Ã£o

ğŸ”„ Build com `rootDir` para estrutura correta  
ğŸ”„ Logs detalhados para debugging  
ğŸ”„ Seed automÃ¡tico sempre que necessÃ¡rio  
ğŸ”„ Versionamento claro via Git  

---

**Ãšltima atualizaÃ§Ã£o**: Janeiro 2025  
**VersÃ£o Backend**: 1.0.0  
**Node.js**: 18.x  
**NestJS**: 11.1.0  

