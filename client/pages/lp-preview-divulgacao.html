<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Preview da LP de Divulga√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>body { margin: 0; background: #f5f6fa; }</style>
</head>
<body>
  <div id="lp-container" style="min-height:100vh"></div>
  
  <!-- üîç DEBUG: Painel de informa√ß√µes do indicador -->
  <div id="debug-panel" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; max-width: 300px; z-index: 9999;">
    <strong>üîç DEBUG - Informa√ß√µes do Link:</strong><br>
    <div id="debug-info">Carregando...</div>
    <button onclick="document.getElementById('debug-panel').style.display='none'" style="margin-top: 5px; padding: 2px 8px; font-size: 10px;">Fechar</button>
  </div>

  <script>
    async function loadLP() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      
      // üîç LOGGING: Capturar e exibir par√¢metros de debugging
      console.log('üîó [LP-DIVULGACAO] Carregando LP de Divulga√ß√£o');
      console.log('üìã [LP-DIVULGACAO] Par√¢metros da URL:', Object.fromEntries(params.entries()));
      
      // Extrair informa√ß√µes do indicador
      const ref = params.get('ref');
      const indicatorName = params.get('indicator_name');
      const utmSource = params.get('utm_source');
      const utmContent = params.get('utm_content');
      const utmCampaign = params.get('utm_campaign');
      
      // Atualizar painel de debug
      const debugInfo = document.getElementById('debug-info');
      debugInfo.innerHTML = `
        <strong>ID da LP:</strong> ${id || 'N/A'}<br>
        <strong>C√≥digo do Indicador:</strong> ${ref || 'N/A'}<br>
        <strong>Nome do Indicador:</strong> ${indicatorName || 'N/A'}<br>
        <strong>UTM Source:</strong> ${utmSource || 'N/A'}<br>
        <strong>UTM Content:</strong> ${utmContent || 'N/A'}<br>
        <strong>UTM Campaign:</strong> ${utmCampaign || 'N/A'}<br>
      `;
      
      console.log('üë§ [LP-DIVULGACAO] Informa√ß√µes do Indicador:', {
        ref, indicatorName, utmSource, utmContent, utmCampaign
      });
      
      if (!id) {
        console.error('‚ùå [LP-DIVULGACAO] ID da LP n√£o informado na URL');
        document.getElementById('lp-container').innerHTML = '<p>ID da LP n√£o informado.</p>';
        return;
      }
      
      // Salva o contexto da LP de Divulga√ß√£o no localStorage
      localStorage.setItem('currentLpDivulgacaoId', id);
      
      // üÜï NOVO: Salvar informa√ß√µes do indicador no localStorage para uso do formul√°rio
      if (ref) localStorage.setItem('currentIndicatorCode', ref);
      if (indicatorName) localStorage.setItem('currentIndicatorName', indicatorName);
      
      try {
        // üîç DEBUG: Verificar URLs e ambiente
        console.log('üîç [DEBUG] Hostname atual:', window.location.hostname);
        console.log('üîç [DEBUG] URL hardcoded (PROBLEMA):', `http://localhost:3000/api/lp-divulgacao/${id}`);
        
        const apiUrl = window.location.hostname === "localhost" ? 
          "http://localhost:3000/api" : 
          "https://programa-indicacao-multicliente-production.up.railway.app/api";
        console.log('üîç [DEBUG] URL correta deveria ser:', `${apiUrl}/lp-divulgacao/${id}`);
        
        // üîç DEBUG: Verificar autentica√ß√£o
        const token = localStorage.getItem('clientToken') || localStorage.getItem('token');
        console.log('üîç [DEBUG] Token dispon√≠vel:', !!token);
        
        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        console.log('üîç [DEBUG] Headers que ser√£o enviados:', headers);
        
        console.log('üåê [LP-DIVULGACAO] Fazendo requisi√ß√£o para o backend...');
        const finalUrl = `${apiUrl}/lp-divulgacao/${id}`;
        console.log('üîß [CORRE√á√ÉO] URL final sendo usada:', finalUrl);
        const res = await fetch(finalUrl, { headers });
        const data = await res.json();
        
        console.log('üì¶ [LP-DIVULGACAO] Resposta do backend:', data);
        
        if (!data.success || !data.data) throw new Error('LP n√£o encontrada');
        
        console.log('‚úÖ [LP-DIVULGACAO] LP carregada com sucesso:', data.data.name);
        
        // Renderiza HTML salvo
        document.getElementById('lp-container').innerHTML = data.data.compiledOutput.html || '<p>LP sem conte√∫do.</p>';
        
        // Injeta CSS salvo, se houver
        if (data.data.compiledOutput.css) {
          const style = document.createElement('style');
          style.innerHTML = data.data.compiledOutput.css;
          document.head.appendChild(style);
          console.log('üé® [LP-DIVULGACAO] CSS da LP aplicado');
        }
        
        // For√ßa o bind do submit do formul√°rio ap√≥s o JS p√∫blico ser carregado
        setTimeout(() => {
          console.log('üîó [LP-DIVULGACAO] Vinculando formul√°rios...');
          if (window.bindReferralForms) {
            window.bindReferralForms();
            console.log('‚úÖ [LP-DIVULGACAO] bindReferralForms executado');
          }
          
          // Fallback: for√ßa o bind manualmente se necess√°rio
          const forms = document.querySelectorAll('.lp-referral-form');
          console.log(`üîç [LP-DIVULGACAO] Formul√°rios encontrados: ${forms.length}`);
          forms.forEach((form, index) => {
            form.onsubmit = function(event) { 
              console.log(`üìù [LP-DIVULGACAO] Submit do formul√°rio ${index + 1}`);
              return window.submitReferralForm(event, form); 
            };
          });
        }, 200);
        
      } catch (err) {
        console.error('üí• [LP-DIVULGACAO] Erro ao carregar LP:', err);
        document.getElementById('lp-container').innerHTML = '<p>Erro ao carregar LP: ' + err.message + '</p>';
      }
    }
    loadLP();
  </script>
  <!-- IMPORTANTE: O JS p√∫blico deve ser importado DEPOIS do script acima -->
  <script src="../js/lp-referral-form-public.js"></script>
</body>
</html> 